// This file of part of the iOS IRC client application OrangeIRC.
//
// Copyright Â© 2016 Andrew Hyatt
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.

import UIKit
import OrangeIRCCore

class NetworksTableViewController : UITableViewController {
    
    init() {
        super.init(style: .grouped)
    }
    
    required init?(coder aDecoder: NSCoder) {
        fatalError("init(coder:) has not been implemented")
    }
    
    override func viewDidLoad() {
        super.viewDidLoad()
        
        title = localized("NETWORKS")
        
        navigationItem.leftBarButtonItem = editButtonItem
        navigationItem.rightBarButtonItem = UIBarButtonItem(barButtonSystemItem: .add, target: self, action: #selector(addServerButton))
        
        NotificationCenter.default.addObserver(self, selector: #selector(updateTableView), name: Notifications.serverDataChanged, object: nil)
        NotificationCenter.default.addObserver(self, selector: #selector(updateTableView), name: Notifications.roomDataChanged, object: nil)
        
        updateTableView()
    }
    
    @objc func updateTableView() {
        if ServerManager.shared.servers.count == 0 {
            let label = UILabel()
            label.text = localized("TAP_TO_ADD_SERVER")
            label.textAlignment = .center
            tableView.backgroundView = label
        } else {
            tableView.backgroundView = nil
        }
        
        tableView.reloadData()
    }
    
    @objc func addServerButton() {
        let tvc = ServerSettingsTableViewController(style: .grouped)
        AppDelegate.showModalGlobally(tvc, style: .formSheet)
    }
    
    override func numberOfSections(in tableView: UITableView) -> Int {
        return ServerManager.shared.servers.count
    }
    
    override func tableView(_ tableView: UITableView, numberOfRowsInSection section: Int) -> Int {
        return 1 + ServerManager.shared.servers[section].rooms.count
    }
    
    override func tableView(_ tableView: UITableView, titleForHeaderInSection section: Int) -> String? {
        return ServerManager.shared.servers[section].displayName
    }
    
    override func tableView(_ tableView: UITableView, viewForHeaderInSection section: Int) -> UIView? {
        let view = NetworkHeaderView.loadFromNib(server: ServerManager.shared.servers[section])
        return view
    }
    
    override func tableView(_ tableView: UITableView, cellForRowAt indexPath: IndexPath) -> UITableViewCell {
        let ID = "RoomCell"
        var cell: UITableViewCell!
        if let dequeuedCell = tableView.dequeueReusableCell(withIdentifier: ID) {
            cell = dequeuedCell
        } else {
            cell = UITableViewCell(style: .value1, reuseIdentifier: ID)
            cell.accessoryType = .disclosureIndicator
        }
        
        let server = ServerManager.shared.servers[indexPath.section]
        
        if indexPath.row == 0 {
            // The "console"
            cell.textLabel?.text = localized("CONSOLE")
            if server.isConnected {
                cell.detailTextLabel?.text = localized("ONLINE")
            } else if server.isConnectingOrRegistering {
                cell.detailTextLabel?.text = localized("CONNECTING")
            } else {
                cell.detailTextLabel?.text = localized("OFFLINE")
            }
            
            // Set icon
            cell.imageView?.image = UIImage(named: "Console")
        } else {
            // A room
            let room = server.rooms[indexPath.row - 1]
            cell.textLabel?.text = room.displayName
            
            if let channel = room as? Channel {
                cell.imageView?.image = channel.isJoined ? UIImage(named: "ChannelOnline") : UIImage(named: "ChannelOffline")
            }
        }
        
        return cell
    }
    
    override func tableView(_ tableView: UITableView, didSelectRowAt indexPath: IndexPath) {
        // Open the room
        let server = ServerManager.shared.servers[indexPath.section]
        
        if indexPath.row == 0 {
            let console = ConsoleTableViewController(server: server)
            AppDelegate.splitView.showDetailViewController(console, sender: nil)
        } else {
            let roomTVC = RoomTableViewController(server.rooms[indexPath.row - 1])
            AppDelegate.splitView.showDetailViewController(UINavigationController(rootViewController: roomTVC), sender: nil)
        }
    }
    
    override func tableView(_ tableView: UITableView, editActionsForRowAt indexPath: IndexPath) -> [UITableViewRowAction]? {
        var actions = [UITableViewRowAction]()
        
        let server = ServerManager.shared.servers[indexPath.section]
        
        if indexPath.row == 0 {
            // Console
            if server.isConnected {
                // Disconnect
                actions.append(UITableViewRowAction(style: .normal, title: localized("DISCONNECT"), handler: { a, i in
                    server.disconnect()
                }))
            } else {
                // Connect
                actions.append(UITableViewRowAction(style: .normal, title: localized("CONNECT"), handler: { a, i in
                    server.connect()
                }))
            }
        } else {
            // Room
            let room = server.rooms[indexPath.row - 1]
            
            // Delete
            actions.append(UITableViewRowAction(style: .destructive, title: localized("DELETE"), handler: { a, i in
                server.delete(room: room)
            }))
            
            if let channel = room as? Channel {
                if server.isConnected {
                    if channel.isJoined {
                        // Leave
                        actions.append(UITableViewRowAction(style: .normal, title: localized("LEAVE"), handler: { a, i in
                            server.leave(channel: channel.name)
                        }))
                    } else {
                        // Join
                        actions.append(UITableViewRowAction(style: .normal, title: localized("JOIN"), handler: { a, i in
                            server.join(channel: channel.name, key: channel.key)
                        }))
                    }
                }
            }
        }
        
        return actions
    }
}
